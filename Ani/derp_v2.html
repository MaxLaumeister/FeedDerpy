<!doctype html>
	<html lang="en">
		<head>
			<meta charset="utf-8" />
			<title>Feed Derpy!</title>
			<style>
				body {
					position: absolute;
					margin: 0;
					width: 100%;
					height: 100%;
					overflow: hidden;
				}
				#muffinbutton {
					top: 30px;
					position: relative;
					margin-left: auto;
					margin-right: auto;
					width: 200px;
					height: 209px;
					background-image: url('basket.png');
					z-index: 3;
					cursor: pointer;
				}
				#derpy {
					position: absolute;
					width: 600px;
					height: 464px;
					background-image: url('sprite.png');
					background-position: 0 1856px;
				}
				.muffin {
					position: absolute;
					width: 100px;
					height: 86px;
					display: block;
					margin-left: auto;
					margin-right: auto;
					background-image: url('muffin.png');
					z-index: 2;
				}
				#outer {
					position: absolute;
					width: 100%;
					height: 464px;
					bottom: -20px;
				}
				#perch {
					position: relative;
					padding-left: 75px;
					margin-left: auto;
					margin-right: auto;
					width: 600px;
					height: 464px;
					z-index: 1;
				}
			</style>
			
		</head>
		<body id="theBody">
		<script type="text/javascript">
		
				window.onload = function() {
					d_idle();
				}
				
				var ih = 464;
				var iw = 600;
				
				var d_idle_frames = {
					timing: [4000, 50, 50, 50, 50],
					coords: [[0, 4*ih], [0, 10*ih], [0, 9*ih], [0, 8*ih], [0, 7*ih]],
					loop: true,
					callback: false
				}
				
				var d_open_frames = {
					timing: [60, 60, 60, 60],
					coords: [[0, 4*ih], [0, 3*ih], [0, 2*ih], [0, ih]],
					loop: false,
					callback: false
				}
				
				var d_close_frames = {
					timing: [60, 60, 60, 60],
					coords: [[0, ih], [0, 2*ih], [0, 3*ih], [0, 4*ih]],
					loop: false,
					callback: true,
					callback_func: function(){animate(document.getElementById("derpy"), d_idle_frames);}
				}
				
				var d_closechew_frames = {
					timing: [60, 60, 60, 100, 100, 100, 100],
					coords: [[0, ih], [0, 2*ih], [0, 3*ih], [0, 5*ih], [0, 6*ih], [0, 5*ih], [0, 6*ih]],
					loop: false,
					callback: true,
					callback_func: function(){animate(document.getElementById("derpy"), d_idle_frames);}
				}
				
				var ani_timeout_id;
				
				var nextframe = function(the_div, frame, frame_descriptor) {
					the_div.style.backgroundPosition = frame_descriptor.coords[frame][0] + "px " + frame_descriptor.coords[frame][1] + "px";
					
					if (frame + 1 >= frame_descriptor.timing.length) {
						animating = false;
						// For a cascading (callback) animation
						if(frame_descriptor.callback) frame_descriptor.callback_func();
						// For a looping animation
						if (frame_descriptor.loop) setTimeout(nextframe, frame_descriptor.timing[frame], the_div, 0, frame_descriptor)
					} else {
						ani_timeout_id = setTimeout(nextframe, frame_descriptor.timing[frame], the_div, frame + 1, frame_descriptor);
					}
				}
				
				// Div to animate, frame timing list, 
				var animate = function(the_div, frame_descriptor){
					window.clearTimeout(ani_timeout_id);
					img_open_frame = 0;
					nextframe(the_div, 0, frame_descriptor);
				}
				
				var newmuffin = function() {
					muffin_img = document.createElement("div");
					muffin_img.className = "muffin";
					return muffin_img;
				}
				
				var muffin_count = 0;
				
				var open = false;
				var closed = false;
				var closechew = false;
				var idle = false;
				
				var clear = function() {
					open = false;
					closed = false;
					closechew = false;
					idle = false;
				}
				
				var busy = function() {
					return (open || closed || closechew);
				}
				
				var d_open = function() {
					if (muffin_count == 0 && !open) {

						var the_div = document.getElementById("derpy");
						animate(the_div, d_open_frames);
						
						clear();
						open = true;
					}
				}
				
				var d_close = function() {
					if (muffin_count == 0 && open && !closechew) {
						
						var the_div = document.getElementById("derpy");
						animate(the_div, d_close_frames);
						
						clear();
						closed = true;
					}
				}
				
				var d_closechew = function() {
					if (muffin_count == 0 && !idle) {
						
						var the_div = document.getElementById("derpy");
						animate(the_div, d_closechew_frames);
						
						clear();
						closechew = true;
					}
				}
				
				var d_idle = function() {
					if (muffin_count == 0 && !open) {
					
						var the_div = document.getElementById("derpy");
						animate(the_div, d_idle_frames);
					
						clear();
						idle = true;
					}
				}
				
				var muffin = function() {
					d_open();
					
					muffin_count += 1;
					
					this.div = newmuffin();
					this.div.style.left = window.innerWidth / 2 - 50 + "px";
					this.div.style.top = "110px";
					document.getElementById("theBody").appendChild(this.div);
					
					this.position = this.div.offsetTop;
					this.speed = 0;
					this.acceleration = 1;
					
					var self = this;
					
					this.update = function() {
						self.speed += self.acceleration;
						self.position += self.speed;
						self.div.style.top = self.position + "px";
						
						if (self.position > window.innerHeight - 350) {
							window.clearInterval(self.interval);
							document.getElementById("theBody").removeChild(self.div);
							muffin_count -= 1;
							d_closechew();
						}
					}
					this.interval = window.setInterval(this.update, 25);
				}
				
				
				
			</script>
			<div class="muffin" style="visibility: hidden;"><!-- Muffin Preload --></div>
			<div id="muffinbutton" onmouseover="d_open()" onmouseout="d_close()" onclick="new muffin()"></div>
			<div id="outer">
				<div id="perch">
					<div id="derpy"></div>
				</div>
			</div>
		</body>
	</html>